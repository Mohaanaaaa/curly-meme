<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Print - Upload</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-slate-50 min-h-screen flex flex-col items-center p-4">

    <div class="w-full max-w-md text-center my-6">
        <h1 class="text-3xl font-extrabold text-slate-800">Secure Print</h1>
    </div>

    <div class="w-full max-w-md bg-white p-6 rounded-3xl shadow-xl mb-4 border border-slate-100">
        <div id="dropZone" class="border-2 border-dashed border-slate-300 rounded-2xl p-6 text-center cursor-pointer hover:border-blue-400 transition-all" onclick="document.getElementById('fileInput').click()">
            <i class="fa-solid fa-file-pdf text-4xl text-blue-500 mb-2"></i>
            <p id="fileName" class="text-slate-700 font-bold">Tap to select document</p>
            <input type="file" name="file" id="fileInput" form="mainForm" class="hidden" required>
        </div>
        
        <div class="grid grid-cols-2 gap-3 mt-4">
            <select name="color" form="mainForm" class="bg-slate-50 p-3 rounded-xl border text-sm outline-none">
                <option value="bw">B&W</option>
                <option value="color">Color</option>
            </select>
            <input type="number" name="copies" form="mainForm" value="1" min="1" class="bg-slate-50 p-3 rounded-xl border text-sm outline-none">
        </div>
    </div>

    <div class="w-full max-w-md flex bg-slate-200 p-1 rounded-2xl mb-4">
        <button type="button" onclick="setMode('manual')" id="btn-manual" class="flex-1 py-3 rounded-xl font-bold text-sm bg-white shadow text-blue-600 transition-all">Manual</button>
        <button type="button" onclick="setMode('scan')" id="btn-scan" class="flex-1 py-3 rounded-xl font-bold text-sm text-slate-600 transition-all">Smart Scan</button>
    </div>

    <div class="w-full max-w-md">
        <form id="mainForm" action="/upload" method="POST" enctype="multipart/form-data">
            <div id="manual-section" class="bg-white p-4 rounded-3xl shadow-lg border">
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-700 transition-all">
                    GENERATE PICKUP CODE
                </button>
            </div>
        </form>

        <div id="scan-section" class="hidden bg-white p-4 rounded-3xl shadow-lg border">
            <div id="reader" class="rounded-2xl overflow-hidden border-4 border-blue-500 bg-black aspect-square mb-3"></div>
            <p class="text-center text-blue-600 font-bold animate-pulse text-sm">SCAN SHOP QR TO DROP FILE</p>
        </div>
    </div>

    <script>
        let html5QrCode = null;

        function setMode(mode) {
            const manualSec = document.getElementById('manual-section');
            const scanSec = document.getElementById('scan-section');
            const btnManual = document.getElementById('btn-manual');
            const btnScan = document.getElementById('btn-scan');

            if (mode === 'scan') {
                manualSec.classList.add('hidden');
                scanSec.classList.remove('hidden');
                btnScan.className = "flex-1 py-3 rounded-xl font-bold text-sm bg-white shadow text-blue-600";
                btnManual.className = "flex-1 py-3 rounded-xl font-bold text-sm text-slate-600";
                startScanner();
            } else {
                manualSec.classList.remove('hidden');
                scanSec.classList.add('hidden');
                btnManual.className = "flex-1 py-3 rounded-xl font-bold text-sm bg-white shadow text-blue-600";
                btnScan.className = "flex-1 py-3 rounded-xl font-bold text-sm text-slate-600";
                if(html5QrCode) html5QrCode.stop().catch(e => console.log(e));
            }
        }

        function startScanner() {
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, (decodedText) => {
                const fileInput = document.getElementById('fileInput');
                if (fileInput.files.length === 0) {
                    alert("Please select a document at the top first!");
                    return;
                }
                const form = document.getElementById('mainForm');
                form.action = decodedText; 
                form.submit();
            });
        }

        document.getElementById('fileInput').onchange = function() {
            if (this.files[0]) {
                document.getElementById('fileName').innerText = "Selected: " + this.files[0].name;
                document.getElementById('dropZone').classList.add('bg-blue-50', 'border-blue-400');
            }
        };
    </script>
</body>
</html>